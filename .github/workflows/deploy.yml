name: Deploy TON (Order Bot via SSH)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-telegram-order-notifier
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # === Prepare SSH key (robust) — stesso stile del tuo workflow React ===
      - name: Prepare SSH key (robust)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "❌ Missing secret VPS_SSH_KEY"; exit 1
          fi
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          printf '%s' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          # normalizza CRLF, \n escaped, BOM
          tr -d '\r' < ~/.ssh/deploy_key > ~/.ssh/_tmp && mv ~/.ssh/_tmp ~/.ssh/deploy_key
          if [ $(wc -l < ~/.ssh/deploy_key) -eq 1 ] && grep -q '\\n' ~/.ssh/deploy_key; then
            sed 's/\\n/\n/g' ~/.ssh/deploy_key > ~/.ssh/_tmp && mv ~/.ssh/_tmp ~/.ssh/deploy_key
          fi
          awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}1' ~/.ssh/deploy_key > ~/.ssh/_tmp && mv ~/.ssh/_tmp ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keygen -y -f ~/.ssh/deploy_key > ~/.ssh/deploy_key.pub
          ssh-keyscan -H -t ed25519 "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H -t rsa     "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      # === Ensure remote app dir (come "Ensure remote release dir" ma senza releases) ===
      - name: Ensure remote app dir
        shell: bash
        run: |
          REMOTE_BASE="/opt/telegram-order-notifier"
          REMOTE_APP="$REMOTE_BASE/app"
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "sudo mkdir -p \"$REMOTE_APP\" \"$REMOTE_BASE/run\" && sudo chown -R deploy:deploy \"$REMOTE_BASE\""

      # === Pull codice (HTTPS repo pubblica) nello stesso path usato dal service ===
      - name: Update code (git over HTTPS)
        shell: bash
        run: |
          REMOTE_APP="/opt/telegram-order-notifier/app"
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "cd \"$REMOTE_APP\" && \
             if [ ! -d .git ]; then \
               git clone https://github.com/tommaso-berti/telegram-order-notifier.git .; \
             else \
               git remote set-url origin https://github.com/tommaso-berti/telegram-order-notifier.git && \
               git fetch --all --prune --depth=1 && \
               git reset --hard origin/main && \
               git clean -fdx; \
             fi"

      # === Venv & deps nella cartella app (matcha ExecStart del tuo service) ===
      - name: Setup venv & install requirements (remote)
        shell: bash
        run: |
          REMOTE_APP="/opt/telegram-order-notifier/app"
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "cd \"$REMOTE_APP\" && \
             python3 -m venv .venv || true && \
             set +u; source .venv/bin/activate; set -u; \
             pip install --upgrade pip && \
             if [ -f requirements.txt ]; then \
               pip install -r requirements.txt; \
             else \
               pip install yfinance python-telegram-bot pyyaml pandas; \
             fi"

      # === Scrive/aggiorna .env dai Secrets nel path che legge il service ===
      - name: Write .env (from GitHub Secrets)
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REMOTE_BASE="/opt/telegram-order-notifier"
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "sudo bash -lc 'cat > ${REMOTE_BASE}/.env <<EOF
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          chmod 640 ${REMOTE_BASE}/.env
          chown deploy:deploy ${REMOTE_BASE}/.env
          '"

      # === Restart service (come il tuo "reload caddy", ma per orderbot) ===
      - name: Restart orderbot.service
        shell: bash
        run: |
          ssh -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "sudo -n systemctl daemon-reload || true; \
             sudo -n systemctl restart orderbot.service || true; \
             sudo -n systemctl status --no-pager orderbot.service || true"