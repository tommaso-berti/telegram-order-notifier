name: Deploy TON (Order Bot su VPS)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency: deploy-telegram-order-notifier

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy & restart (SSH)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            APP_DIR="/opt/telegram-order-notifier/app"
            RUN_DIR="/opt/telegram-order-notifier/run"
            SERVICE="orderbot.service"
            BRANCH="main"

            cd "$APP_DIR"
            if [ ! -d .git ]; then
              git clone https://github.com/tommaso-berti/telegram-order-notifier.git .
            fi

            # ensure origin over HTTPS (public)
            git remote set-url origin https://github.com/tommaso-berti/telegram-order-notifier.git

            git fetch --all --prune --depth=1
            git reset --hard "origin/${BRANCH}"
            git clean -fdx

            python3 -m venv .venv || true
            set +u; source .venv/bin/activate; set -u
            pip install --upgrade pip
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            else
              pip install yfinance python-telegram-bot pyyaml pandas
            fi
            deactivate

            # write .env from Secrets (Option A)
            sudo bash -lc "cat > /opt/telegram-order-notifier/.env <<EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
            EOF
            chmod 640 /opt/telegram-order-notifier/.env
            chown deploy:deploy /opt/telegram-order-notifier/.env"
            
            sudo mkdir -p "$RUN_DIR"
            sudo chown -R deploy:deploy "$RUN_DIR"
            
            sudo systemctl daemon-reload || true
            sudo systemctl restart "${SERVICE}"
            sudo systemctl status --no-pager "${SERVICE}" || true