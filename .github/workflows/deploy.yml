name: Deploy TON (Order Bot via SSH)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-telegram-order-notifier
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Prepare SSH key (robust) — same pattern as your React workflow
      - name: Prepare SSH key (robust)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "❌ Missing secret VPS_SSH_KEY"; exit 1
          fi
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          printf '%s' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          # normalize CRLF, escaped \n, BOM
          tr -d '\r' < ~/.ssh/deploy_key > ~/.ssh/_tmp && mv ~/.ssh/_tmp ~/.ssh/deploy_key
          if [ $(wc -l < ~/.ssh/deploy_key) -eq 1 ] && grep -q '\\n' ~/.ssh/deploy_key; then
            sed 's/\\n/\n/g' ~/.ssh/deploy_key > ~/.ssh/_tmp && mv ~/.ssh/_tmp ~/.ssh/deploy_key
          fi
          awk 'NR==1{sub(/^\xef\xbb\xbf/,"")}1' ~/.ssh/deploy_key > ~/.ssh/_tmp && mv ~/.ssh/_tmp ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keygen -y -f ~/.ssh/deploy_key > ~/.ssh/deploy_key.pub
          # known_hosts (force IPv4 to avoid AAAA/IPv6 issues)
          ssh-keyscan -4 -H -t ed25519 "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -4 -H -t rsa     "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

      # Ensure remote app dir (no sudo; directories were created in server setup)
      - name: Ensure remote app dir
        shell: bash
        run: |
          REMOTE_BASE="/opt/telegram-order-notifier"
          REMOTE_APP="$REMOTE_BASE/app"
          ssh -4 -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "mkdir -p \"$REMOTE_APP\" \"$REMOTE_BASE/run\""

      # Update code (public repo over HTTPS) in the same path used by systemd
      - name: Update code (git over HTTPS)
        shell: bash
        run: |
          REMOTE_APP="/opt/telegram-order-notifier/app"
          ssh -4 -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "cd \"$REMOTE_APP\" && \
             if [ ! -d .git ]; then \
               git clone https://github.com/tommaso-berti/telegram-order-notifier.git .; \
             else \
               git remote set-url origin https://github.com/tommaso-berti/telegram-order-notifier.git && \
               git fetch --all --prune --depth=1 && \
               git reset --hard origin/main && \
               git clean -fdx; \
             fi"

      # Virtualenv & dependencies (inside /app to match ExecStart)
      - name: Setup venv & install requirements (remote)
        shell: bash
        run: |
          REMOTE_APP="/opt/telegram-order-notifier/app"
          ssh -4 -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "cd \"$REMOTE_APP\" && \
             python3 -m venv .venv || true && \
             set +u; source .venv/bin/activate; set -u; \
             pip install --upgrade pip && \
             if [ -f requirements.txt ]; then \
               pip install -r requirements.txt; \
             else \
               pip install yfinance python-telegram-bot pyyaml pandas; \
             fi"

      # Write .env from GitHub Secrets (no sudo: file lives in /opt/telegram-order-notifier owned by deploy)
      - name: Write .env (from GitHub Secrets)
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          REMOTE_BASE="/opt/telegram-order-notifier"
          ssh -4 -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "cat > ${REMOTE_BASE}/.env <<EOF
          TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
          EOF
          chmod 640 ${REMOTE_BASE}/.env"

      # Restart orderbot.service (requires sudoers NOPASSWD for systemctl)
      - name: Restart orderbot.service
        shell: bash
        run: |
          ssh -4 -o IdentitiesOnly=yes -i ~/.ssh/deploy_key "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "sudo -n systemctl daemon-reload || true; \
             sudo -n systemctl restart orderbot.service || true; \
             sudo -n systemctl status --no-pager orderbot.service || true"